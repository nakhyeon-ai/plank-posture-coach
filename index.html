<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>AI í”Œë­í¬ ìì„¸ êµì •ê¸°</title>

  <!-- Teachable Machine + TensorFlow.js -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.9.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8/dist/teachablemachine-image.min.js"></script>

  <style>
    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: "Segoe UI", system-ui, sans-serif;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px;

      /* í—¬ìŠ¤ì¥ ë°°ê²½ */
      background-image: url("gym-bg.jpg");
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;

      position: relative;
    }

    /* ë°°ê²½ ì–´ë‘ìš´ ë ˆì´ì–´ */
    body::before {
      content: "";
      position: absolute;
      inset: 0;
      background: rgba(0, 0, 0, 0.45);
      backdrop-filter: blur(1px);
      z-index: 0;
    }

    /* ë©”ì¸ ì¹´ë“œ UI */
    .card {
      width: 100%;
      max-width: 900px;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 18px;
      padding: 24px 28px 28px;
      box-shadow: 0 18px 45px rgba(0, 0, 0, 0.4);
      position: relative;
      z-index: 1;
      backdrop-filter: blur(4px);
    }

    h1 {
      margin: 0 0 8px;
      font-size: 1.8rem;
      font-weight: 700;
      text-align: center;
    }

    .subtitle {
      text-align: center;
      margin: 0 0 16px;
      color: #475569;
      font-size: 1rem;
    }

    #webcam-container {
      margin-top: 16px;
      display: flex;
      justify-content: center;
    }

    /* ì›¹ìº  ìº”ë²„ìŠ¤ */
    #webcam-container canvas {
      width: 100%;
      max-width: 720px;
      border-radius: 16px;
      background: black;
      box-shadow: 0 12px 35px rgba(0, 0, 0, 0.45);
    }

    #label {
      margin-top: 12px;
      font-size: 0.95rem;
      text-align: center;
      color: #64748b;
    }

    #message {
      margin-top: 8px;
      font-size: 1.2rem;
      font-weight: 600;
      text-align: center;
      color: #1e293b;
    }

    button {
      padding: 12px 24px;
      display: block;
      margin: 0 auto;
      cursor: pointer;
      border-radius: 999px;
      border: none;
      background: linear-gradient(135deg, #3b82f6, #06b6d4);
      color: white;
      font-size: 1rem;
      font-weight: 600;
      letter-spacing: 0.02em;
      transition: 0.2s;
    }

    button:hover { filter: brightness(1.1); }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
  </style>
</head>

<body>
  <div class="card">
    <h1>í”Œë­í¬ ìì„¸ êµì •ê¸°</h1>
    <p class="subtitle">
      ë²„íŠ¼ì„ ëˆŒëŸ¬ ì¹´ë©”ë¼ë¥¼ ì¼œë©´, Teachable Machineì´ í”Œë­í¬ ìì„¸ë¥¼ ì‹¤ì‹œê°„ ë¶„ì„í•©ë‹ˆë‹¤.
    </p>

    <button id="start-btn" onclick="init()">ì¹´ë©”ë¼ ì¼œê¸°</button>

    <div id="webcam-container"></div>
    <div id="label">ì•„ì§ ì¸ì‹ ì „ì…ë‹ˆë‹¤.</div>
    <div id="message">ì¹´ë©”ë¼ë¥¼ ì¼œê³  í”Œë­í¬ ìì„¸ë¥¼ ì·¨í•´ë³´ì„¸ìš”!</div>
  </div>

  <script>
    const URL = "https://teachablemachine.withgoogle.com/models/VOc3k_qRC/";

    let model, webcam, maxPredictions;
    let lastPosture = "";
    let lastSpeakTime = 0;
    let inited = false;  // ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€

    async function init() {
      if (inited) return;   // ì´ë¯¸ ì‹¤í–‰ë˜ë©´ ë¬´ì‹œ
      inited = true;

      const btn = document.getElementById("start-btn");
      btn.disabled = true;
      btn.innerText = "ì¹´ë©”ë¼ ì‘ë™ ì¤‘";

      const modelURL = URL + "model.json";
      const metadataURL = URL + "metadata.json";

      model = await tmImage.load(modelURL, metadataURL);
      maxPredictions = model.getTotalClasses();

      const flip = true;
      webcam = new tmImage.Webcam(640, 480, flip);
      await webcam.setup();
      await webcam.play();

      const container = document.getElementById("webcam-container");
      container.innerHTML = "";            // ê¸°ì¡´ í™”ë©´ ì œê±°
      container.appendChild(webcam.canvas);

      document.getElementById("message").innerText =
        "ì¹´ë©”ë¼ê°€ ì¼œì¡Œì–´ìš”! í”Œë­í¬ ìì„¸ë¥¼ ìœ ì§€í•´ ë³´ì„¸ìš”.";

      window.requestAnimationFrame(loop);
    }

    async function loop() {
      webcam.update();
      await predict();
      window.requestAnimationFrame(loop);
    }

    async function predict() {
      const prediction = await model.predict(webcam.canvas);

      let bestClass = "";
      let bestProb = 0;

      for (let i = 0; i < prediction.length; i++) {
        if (prediction[i].probability > bestProb) {
          bestProb = prediction[i].probability;
          bestClass = prediction[i].className;
        }
      }

      document.getElementById("label").innerText =
        `í˜„ì¬ ìì„¸: ${bestClass} (${(bestProb * 100).toFixed(1)}%)`;

      let msg = "";

      if (bestProb < 0.7) {
        msg = "ìì„¸ë¥¼ ì¸ì‹í•˜ëŠ” ì¤‘ì´ì—ìš”. í”Œë­í¬ë¥¼ ì¡°ê¸ˆë§Œ ë” ìœ ì§€í•´ ì£¼ì„¸ìš”!";
      } else if (bestClass === "ì¢‹ì•„ìš”!") {
        msg = "ì¢‹ì•„ìš”! ì§€ê¸ˆ ìì„¸ë¥¼ ê·¸ëŒ€ë¡œ ìœ ì§€í•´ ë³´ì„¸ìš” ğŸ’ª";
      } else if (bestClass === "í—ˆë¦¬ ë†’ì•„ìš”!") {
        msg = "í—ˆë¦¬ê°€ ë„ˆë¬´ ë†’ì•„ìš”! ì—‰ë©ì´ë¥¼ ì‚´ì§ ë‚´ë ¤ì£¼ì„¸ìš”.";
      } else if (bestClass === "í—ˆë¦¬ ë‚®ì•„ìš”!") {
        msg = "ì—‰ë©ì´ê°€ ë„ˆë¬´ ë‚®ì•„ìš”! ë³µë¶€ì— í˜ì„ ì£¼ê³  ì¡°ê¸ˆ ë“¤ì–´ ì˜¬ë ¤ë³´ì„¸ìš”.";
      } else {
        msg = "ìì„¸ë¥¼ ë‹¤ì‹œ í•œ ë²ˆ ì¡ì•„ë³¼ê¹Œìš”?";
      }

      document.getElementById("message").innerText = msg;

      // ìŒì„± ì•ˆë‚´: 3ì´ˆë§ˆë‹¤, ë‹¤ë¥¸ ìì„¸ì¼ ë•Œë§Œ
      const now = Date.now();
      if (msg && bestClass !== lastPosture && now - lastSpeakTime > 3000) {
        speak(msg);
        lastPosture = bestClass;
        lastSpeakTime = now;
      }
    }

    function speak(text) {
      if (!("speechSynthesis" in window)) return;

      const utter = new SpeechSynthesisUtterance(text);
      utter.lang = "ko-KR";
      window.speechSynthesis.cancel();
      window.speechSynthesis.speak(utter);
    }
  </script>
</body>
</html>
